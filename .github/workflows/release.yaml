name: Release Charts

on:
  workflow_dispatch:

jobs:
  release:
    name: Package and Publish Charts
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CR_VERSION: "1.7.0"
      GIT_CLIFF_VERSION: "2.7.0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git-cliff and tag comparison
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Install yq
        run: |
          curl -sSLo /tmp/yq.tar.gz \
            "https://github.com/mikefarah/yq/releases/download/v4.45.1/yq_linux_amd64.tar.gz"
          tar -xzf /tmp/yq.tar.gz -C /tmp
          sudo mv /tmp/yq_linux_amd64 /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Install chart-releaser (cr)
        run: |
          curl -sSLo /tmp/cr.tar.gz \
            "https://github.com/helm/chart-releaser/releases/download/v${CR_VERSION}/chart-releaser_${CR_VERSION}_linux_amd64.tar.gz"
          tar -xzf /tmp/cr.tar.gz -C /tmp cr
          sudo mv /tmp/cr /usr/local/bin/cr
          cr version

      - name: Install git-cliff
        run: |
          curl -sSLo /tmp/git-cliff.tar.gz \
            "https://github.com/orhun/git-cliff/releases/download/v${GIT_CLIFF_VERSION}/git-cliff-${GIT_CLIFF_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          tar -xzf /tmp/git-cliff.tar.gz -C /tmp --strip-components=1 \
            "git-cliff-${GIT_CLIFF_VERSION}/git-cliff"
          sudo mv /tmp/git-cliff /usr/local/bin/git-cliff
          git-cliff --version

      - name: Detect releasable charts
        id: detect
        run: |
          RELEASABLE=""
          for chart_dir in charts/*/; do
            chart_yaml="$chart_dir/Chart.yaml"
            [ -f "$chart_yaml" ] || continue

            chart_name=$(yq e '.name' "$chart_yaml")

            # Check if there are commits since the last tag for this chart
            PREV_TAG=$(git tag -l "${chart_name}-*" --sort=-v:refname | head -n 1)

            if [ -n "$PREV_TAG" ]; then
              # Check for commits since last tag
              COMMITS=$(git log "$PREV_TAG..HEAD" --oneline -- "charts/$chart_name" 2>/dev/null | wc -l)
              if [ "$COMMITS" -eq 0 ]; then
                echo "No changes for $chart_name since $PREV_TAG — skipping"
                continue
              fi
              echo "Found $COMMITS new commits for $chart_name"
            fi

            # Chart is releasable
            echo "Chart $chart_name will be released"
            RELEASABLE="$RELEASABLE $chart_name"
          done

          RELEASABLE=$(echo "$RELEASABLE" | xargs)
          if [ -z "$RELEASABLE" ]; then
            echo "No charts to release."
            echo "any_releasable=false" >> "$GITHUB_OUTPUT"
          else
            echo "Charts to release: $RELEASABLE"
            echo "any_releasable=true" >> "$GITHUB_OUTPUT"
            echo "charts=$RELEASABLE" >> "$GITHUB_OUTPUT"
          fi

      - name: Calculate chart versions
        id: versions
        if: steps.detect.outputs.any_releasable == 'true'
        run: |
          VERSIONS_JSON="{"
          for chart_name in ${{ steps.detect.outputs.charts }}; do
            chart_dir="charts/$chart_name"
            chart_yaml="$chart_dir/Chart.yaml"

            # Find previous tag for this chart
            PREV_TAG=$(git tag -l "${chart_name}-*" --sort=-v:refname | head -n 1)

            if [ -n "$PREV_TAG" ]; then
              echo "Previous tag for $chart_name: $PREV_TAG"

              # Use git-cliff --bump to calculate next version
              # --context outputs JSON with the calculated version without creating tags
              NEXT_VERSION=$(git-cliff --config cliff.toml --include-path "charts/${chart_name}/**" --bump --context 2>/dev/null | jq -r '.[0].version' 2>/dev/null)

              if [ -n "$NEXT_VERSION" ] && [ "$NEXT_VERSION" != "null" ]; then
                NEW_VERSION="$NEXT_VERSION"
                echo "git-cliff calculated version: $NEW_VERSION"
              else
                echo "ERROR: git-cliff could not calculate version for $chart_name"
                exit 1
              fi
            else
              # First release - start at 0.1.0
              echo "No previous tag for $chart_name - starting at 0.1.0"
              NEW_VERSION="0.1.0"
            fi

            echo "Calculated version for $chart_name: $NEW_VERSION"

            # Update Chart.yaml with new version
            yq e -i ".version = \"$NEW_VERSION\"" "$chart_yaml"

            # Add to JSON output
            [ "$VERSIONS_JSON" != "{" ] && VERSIONS_JSON="$VERSIONS_JSON,"
            VERSIONS_JSON="$VERSIONS_JSON\"$chart_name\":\"$NEW_VERSION\""
          done
          VERSIONS_JSON="$VERSIONS_JSON}"

          echo "versions_json=$VERSIONS_JSON" >> "$GITHUB_OUTPUT"
          echo "Versions JSON: $VERSIONS_JSON"

      - name: Commit version bumps
        if: steps.detect.outputs.any_releasable == 'true'
        run: |
          git add charts/*/Chart.yaml
          git commit -m "chore: bump chart versions for release [skip ci]" || true
          git push origin main

      - name: Package charts and generate changelogs
        if: steps.detect.outputs.any_releasable == 'true'
        env:
          CHARTS: ${{ steps.detect.outputs.charts }}
        run: |
          mkdir -p .cr-release-packages
          mkdir -p /tmp/changelogs

          for chart_name in $CHARTS; do
            chart_dir="charts/$chart_name"
            chart_version=$(yq e '.version' "$chart_dir/Chart.yaml")
            tag="${chart_name}-${chart_version}"

            echo "::group::Package $chart_name ($chart_version)"

            # Update dependencies
            helm dependency update "$chart_dir" 2>/dev/null || true

            # Package chart
            helm package "$chart_dir" --destination .cr-release-packages/
            echo "::endgroup::"

            echo "::group::Generate changelog for $chart_name"

            # Find the previous tag for this chart
            PREV_TAG=$(git tag -l "${chart_name}-*" --sort=-v:refname | head -n 1)

            # Generate changelog with git-cliff scoped to the chart's directory
            # The --tag flag tells git-cliff which version this release represents
            CLIFF_ARGS=(
              --config cliff.toml
              --include-path "charts/${chart_name}/**"
              --strip header
              --tag "$tag"
            )

            if [ -n "$PREV_TAG" ]; then
              echo "Generating changelog from $PREV_TAG to $tag"
              CLIFF_ARGS+=("$PREV_TAG..HEAD")
            else
              echo "No previous tag found — generating full changelog for $tag"
            fi

            git-cliff "${CLIFF_ARGS[@]}" > "/tmp/changelogs/${chart_name}.md" 2>/dev/null || true

            # If changelog is empty, add a default message
            if [ ! -s "/tmp/changelogs/${chart_name}.md" ]; then
              echo "Release ${chart_name} ${chart_version}" > "/tmp/changelogs/${chart_name}.md"
            fi

            echo "--- Changelog for $chart_name ---"
            cat "/tmp/changelogs/${chart_name}.md"
            echo "::endgroup::"
          done

      - name: Create GitHub releases
        if: steps.detect.outputs.any_releasable == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS: ${{ steps.detect.outputs.charts }}
        run: |
          OWNER=$(echo "${{ github.repository }}" | cut -d/ -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d/ -f2)

          for chart_name in $CHARTS; do
            chart_version=$(yq e '.version' "charts/$chart_name/Chart.yaml")
            tag="${chart_name}-${chart_version}"
            changelog="/tmp/changelogs/${chart_name}.md"
            package=$(ls .cr-release-packages/${chart_name}-${chart_version}.tgz 2>/dev/null)

            if [ -z "$package" ]; then
              echo "ERROR: Package not found for $chart_name-$chart_version"
              continue
            fi

            echo "::group::Release $tag"

            # Create the git tag
            git tag "$tag"
            git push origin "$tag"

            # Create GitHub release with changelog body
            gh release create "$tag" \
              "$package" \
              --title "$tag" \
              --notes-file "$changelog" \
              --repo "${{ github.repository }}"

            echo "::endgroup::"
          done

      - name: Update Helm repo index on gh-pages
        if: steps.detect.outputs.any_releasable == 'true'
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER=$(echo "${{ github.repository }}" | cut -d/ -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d/ -f2)

          # Create temp directory for index (avoid .cr-index which cr uses for worktree)
          mkdir -p /tmp/cr-index

          cr index \
            --owner "$OWNER" \
            --git-repo "$REPO" \
            --pages-branch gh-pages \
            --package-path .cr-release-packages \
            --index-path /tmp/cr-index/index.yaml \
            --push
